import { coerceBooleanProperty } from '@angular/cdk/coercion';
import { Directive, HostBinding, HostListener, Input } from '@angular/core';
import * as i0 from "@angular/core";
const TRANSITION_BREAK_OPACITY = 0.5;
const GRADIENT = 'rgba({{color}}, 0.2) 0, rgba({{color}}, 0.3) 40%, rgba({{color}}, 0.4) 50%, rgba({{color}}, 0.5) 60%, rgba({{color}}, 0) 70%';
const DEFAULT_RIPPLE_COLOR = [0, 0, 0];
const BOOTSTRAP_COLORS = [
    'primary',
    'secondary',
    'success',
    'danger',
    'warning',
    'info',
    'light',
    'dark',
];
export class MdbRippleDirective {
    constructor(_elementRef, _renderer) {
        this._elementRef = _elementRef;
        this._renderer = _renderer;
        this._rippleCentered = false;
        this.rippleColor = '';
        this.rippleDuration = '500ms';
        this.rippleRadius = 0;
        this._rippleUnbound = false;
        this.ripple = true;
    }
    get rippleCentered() {
        return this._rippleCentered;
    }
    set rippleCentered(value) {
        this._rippleCentered = coerceBooleanProperty(value);
    }
    get rippleUnbound() {
        return this._rippleUnbound;
    }
    set rippleUnbound(value) {
        this._rippleUnbound = coerceBooleanProperty(value);
    }
    get host() {
        return this._elementRef.nativeElement;
    }
    _createRipple(event) {
        const { layerX, layerY } = event;
        const offsetX = layerX;
        const offsetY = layerY;
        const height = this.host.offsetHeight;
        const width = this.host.offsetWidth;
        const duration = this._durationToMsNumber(this.rippleDuration);
        const diameterOptions = {
            offsetX: this.rippleCentered ? height / 2 : offsetX,
            offsetY: this.rippleCentered ? width / 2 : offsetY,
            height,
            width,
        };
        const diameter = this._getDiameter(diameterOptions);
        const radiusValue = this.rippleRadius || diameter / 2;
        const opacity = {
            delay: duration * TRANSITION_BREAK_OPACITY,
            duration: duration - duration * TRANSITION_BREAK_OPACITY,
        };
        const styles = {
            left: this.rippleCentered ? `${width / 2 - radiusValue}px` : `${offsetX - radiusValue}px`,
            top: this.rippleCentered ? `${height / 2 - radiusValue}px` : `${offsetY - radiusValue}px`,
            height: `${this.rippleRadius * 2 || diameter}px`,
            width: `${this.rippleRadius * 2 || diameter}px`,
            transitionDelay: `0s, ${opacity.delay}ms`,
            transitionDuration: `${duration}ms, ${opacity.duration}ms`,
        };
        const rippleHTML = this._renderer.createElement('div');
        this._createHTMLRipple(this.host, rippleHTML, styles);
        this._removeHTMLRipple(rippleHTML, duration);
    }
    _createHTMLRipple(wrapper, ripple, styles) {
        Object.keys(styles).forEach((property) => (ripple.style[property] = styles[property]));
        this._renderer.addClass(ripple, 'ripple-wave');
        if (this.rippleColor !== '') {
            this._removeOldColorClasses(wrapper);
            this._addColor(ripple, wrapper);
        }
        this._toggleUnbound(wrapper);
        this._appendRipple(ripple, wrapper);
    }
    _removeHTMLRipple(ripple, duration) {
        setTimeout(() => {
            if (ripple) {
                ripple.remove();
            }
        }, duration);
    }
    _durationToMsNumber(time) {
        return Number(time.replace('ms', '').replace('s', '000'));
    }
    _getDiameter({ offsetX, offsetY, height, width }) {
        const top = offsetY <= height / 2;
        const left = offsetX <= width / 2;
        const pythagorean = (sideA, sideB) => Math.sqrt(sideA ** 2 + sideB ** 2);
        const positionCenter = offsetY === height / 2 && offsetX === width / 2;
        // mouse position on the quadrants of the coordinate system
        const quadrant = {
            first: top === true && left === false,
            second: top === true && left === true,
            third: top === false && left === true,
            fourth: top === false && left === false,
        };
        const getCorner = {
            topLeft: pythagorean(offsetX, offsetY),
            topRight: pythagorean(width - offsetX, offsetY),
            bottomLeft: pythagorean(offsetX, height - offsetY),
            bottomRight: pythagorean(width - offsetX, height - offsetY),
        };
        let diameter = 0;
        if (positionCenter || quadrant.fourth) {
            diameter = getCorner.topLeft;
        }
        else if (quadrant.third) {
            diameter = getCorner.topRight;
        }
        else if (quadrant.second) {
            diameter = getCorner.bottomRight;
        }
        else if (quadrant.first) {
            diameter = getCorner.bottomLeft;
        }
        return diameter * 2;
    }
    _appendRipple(target, parent) {
        const FIX_ADD_RIPPLE_EFFECT = 50; // delay for active animations
        this._renderer.appendChild(parent, target);
        setTimeout(() => {
            this._renderer.addClass(target, 'active');
        }, FIX_ADD_RIPPLE_EFFECT);
    }
    _toggleUnbound(target) {
        if (this.rippleUnbound) {
            this._renderer.addClass(target, 'ripple-surface-unbound');
        }
        else {
            this._renderer.removeClass(target, 'ripple-surface-unbound');
        }
    }
    _addColor(target, parent) {
        const isBootstrapColor = BOOTSTRAP_COLORS.find((color) => color === this.rippleColor.toLowerCase());
        if (isBootstrapColor) {
            this._renderer.addClass(parent, `${'ripple-surface'}-${this.rippleColor.toLowerCase()}`);
        }
        else {
            const rgbValue = this._colorToRGB(this.rippleColor).join(',');
            const gradientImage = GRADIENT.split('{{color}}').join(`${rgbValue}`);
            target.style.backgroundImage = `radial-gradient(circle, ${gradientImage})`;
        }
    }
    _removeOldColorClasses(target) {
        const REGEXP_CLASS_COLOR = new RegExp(`${'ripple-surface'}-[a-z]+`, 'gi');
        const PARENT_CLASSS_COLOR = target.classList.value.match(REGEXP_CLASS_COLOR) || [];
        PARENT_CLASSS_COLOR.forEach((className) => {
            this._renderer.removeClass(target, className);
        });
    }
    _colorToRGB(color) {
        // eslint-disable-next-line no-shadow,@typescript-eslint/no-shadow
        function hexToRgb(color) {
            const HEX_COLOR_LENGTH = 7;
            const IS_SHORT_HEX = color.length < HEX_COLOR_LENGTH;
            if (IS_SHORT_HEX) {
                color = `#${color[1]}${color[1]}${color[2]}${color[2]}${color[3]}${color[3]}`;
            }
            return [
                parseInt(color.substr(1, 2), 16),
                parseInt(color.substr(3, 2), 16),
                parseInt(color.substr(5, 2), 16),
            ];
        }
        // eslint-disable-next-line no-shadow,@typescript-eslint/no-shadow
        function namedColorsToRgba(color) {
            const tempElem = document.body.appendChild(document.createElement('fictum'));
            const flag = 'rgb(1, 2, 3)';
            tempElem.style.color = flag;
            if (tempElem.style.color !== flag) {
                return DEFAULT_RIPPLE_COLOR;
            }
            tempElem.style.color = color;
            if (tempElem.style.color === flag || tempElem.style.color === '') {
                return DEFAULT_RIPPLE_COLOR;
            } // color parse failed
            color = getComputedStyle(tempElem).color;
            document.body.removeChild(tempElem);
            return color;
        }
        // eslint-disable-next-line no-shadow, @typescript-eslint/no-shadow
        function rgbaToRgb(color) {
            color = color.match(/[.\d]+/g).map((a) => +Number(a));
            color.length = 3;
            return color;
        }
        if (color.toLowerCase() === 'transparent') {
            return DEFAULT_RIPPLE_COLOR;
        }
        if (color[0] === '#') {
            return hexToRgb(color);
        }
        if (color.indexOf('rgb') === -1) {
            color = namedColorsToRgba(color);
        }
        if (color.indexOf('rgb') === 0) {
            return rgbaToRgb(color);
        }
        return DEFAULT_RIPPLE_COLOR;
    }
}
MdbRippleDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.4", ngImport: i0, type: MdbRippleDirective, deps: [{ token: i0.ElementRef }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Directive });
MdbRippleDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.2.4", type: MdbRippleDirective, selector: "[mdbRipple]", inputs: { rippleCentered: "rippleCentered", rippleColor: "rippleColor", rippleDuration: "rippleDuration", rippleRadius: "rippleRadius", rippleUnbound: "rippleUnbound" }, host: { listeners: { "click": "_createRipple($event)" }, properties: { "class.ripple-surface": "this.ripple" } }, exportAs: ["mdbRipple"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.4", ngImport: i0, type: MdbRippleDirective, decorators: [{
            type: Directive,
            args: [{
                    // eslint-disable-next-line @angular-eslint/directive-selector
                    selector: '[mdbRipple]',
                    exportAs: 'mdbRipple',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.Renderer2 }]; }, propDecorators: { rippleCentered: [{
                type: Input
            }], rippleColor: [{
                type: Input
            }], rippleDuration: [{
                type: Input
            }], rippleRadius: [{
                type: Input
            }], rippleUnbound: [{
                type: Input
            }], ripple: [{
                type: HostBinding,
                args: ['class.ripple-surface']
            }], _createRipple: [{
                type: HostListener,
                args: ['click', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmlwcGxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL21kYi1hbmd1bGFyLXVpLWtpdC9yaXBwbGUvcmlwcGxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWdCLHFCQUFxQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDNUUsT0FBTyxFQUFFLFNBQVMsRUFBYyxXQUFXLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBYSxNQUFNLGVBQWUsQ0FBQzs7QUFFbkcsTUFBTSx3QkFBd0IsR0FBRyxHQUFHLENBQUM7QUFFckMsTUFBTSxRQUFRLEdBQ1osOEhBQThILENBQUM7QUFDakksTUFBTSxvQkFBb0IsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDdkMsTUFBTSxnQkFBZ0IsR0FBRztJQUN2QixTQUFTO0lBQ1QsV0FBVztJQUNYLFNBQVM7SUFDVCxRQUFRO0lBQ1IsU0FBUztJQUNULE1BQU07SUFDTixPQUFPO0lBQ1AsTUFBTTtDQUNQLENBQUM7QUFPRixNQUFNLE9BQU8sa0JBQWtCO0lBdUI3QixZQUFvQixXQUF1QixFQUFVLFNBQW9CO1FBQXJELGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBVztRQWZqRSxvQkFBZSxHQUFHLEtBQUssQ0FBQztRQUV2QixnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUNqQixtQkFBYyxHQUFHLE9BQU8sQ0FBQztRQUN6QixpQkFBWSxHQUFHLENBQUMsQ0FBQztRQVNsQixtQkFBYyxHQUFHLEtBQUssQ0FBQztRQVFNLFdBQU0sR0FBRyxJQUFJLENBQUM7SUFOeUIsQ0FBQztJQXRCN0UsSUFDSSxjQUFjO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUM5QixDQUFDO0lBQ0QsSUFBSSxjQUFjLENBQUMsS0FBYztRQUMvQixJQUFJLENBQUMsZUFB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TyxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9vbGVhbklucHV0LCBjb2VyY2VCb29sZWFuUHJvcGVydHkgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBIb3N0QmluZGluZywgSG9zdExpc3RlbmVyLCBJbnB1dCwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmNvbnN0IFRSQU5TSVRJT05fQlJFQUtfT1BBQ0lUWSA9IDAuNTtcblxuY29uc3QgR1JBRElFTlQgPVxuICAncmdiYSh7e2NvbG9yfX0sIDAuMikgMCwgcmdiYSh7e2NvbG9yfX0sIDAuMykgNDAlLCByZ2JhKHt7Y29sb3J9fSwgMC40KSA1MCUsIHJnYmEoe3tjb2xvcn19LCAwLjUpIDYwJSwgcmdiYSh7e2NvbG9yfX0sIDApIDcwJSc7XG5jb25zdCBERUZBVUxUX1JJUFBMRV9DT0xPUiA9IFswLCAwLCAwXTtcbmNvbnN0IEJPT1RTVFJBUF9DT0xPUlMgPSBbXG4gICdwcmltYXJ5JyxcbiAgJ3NlY29uZGFyeScsXG4gICdzdWNjZXNzJyxcbiAgJ2RhbmdlcicsXG4gICd3YXJuaW5nJyxcbiAgJ2luZm8nLFxuICAnbGlnaHQnLFxuICAnZGFyaycsXG5dO1xuXG5ARGlyZWN0aXZlKHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9kaXJlY3RpdmUtc2VsZWN0b3JcbiAgc2VsZWN0b3I6ICdbbWRiUmlwcGxlXScsXG4gIGV4cG9ydEFzOiAnbWRiUmlwcGxlJyxcbn0pXG5leHBvcnQgY2xhc3MgTWRiUmlwcGxlRGlyZWN0aXZlIHtcbiAgQElucHV0KClcbiAgZ2V0IHJpcHBsZUNlbnRlcmVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9yaXBwbGVDZW50ZXJlZDtcbiAgfVxuICBzZXQgcmlwcGxlQ2VudGVyZWQodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9yaXBwbGVDZW50ZXJlZCA9IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSh2YWx1ZSk7XG4gIH1cbiAgcHJpdmF0ZSBfcmlwcGxlQ2VudGVyZWQgPSBmYWxzZTtcblxuICBASW5wdXQoKSByaXBwbGVDb2xvciA9ICcnO1xuICBASW5wdXQoKSByaXBwbGVEdXJhdGlvbiA9ICc1MDBtcyc7XG4gIEBJbnB1dCgpIHJpcHBsZVJhZGl1cyA9IDA7XG5cbiAgQElucHV0KClcbiAgZ2V0IHJpcHBsZVVuYm91bmQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX3JpcHBsZVVuYm91bmQ7XG4gIH1cbiAgc2V0IHJpcHBsZVVuYm91bmQodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9yaXBwbGVVbmJvdW5kID0gY29lcmNlQm9vbGVhblByb3BlcnR5KHZhbHVlKTtcbiAgfVxuICBwcml2YXRlIF9yaXBwbGVVbmJvdW5kID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZWxlbWVudFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMikge31cblxuICBnZXQgaG9zdCgpOiBIVE1MRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnY2xhc3MucmlwcGxlLXN1cmZhY2UnKSByaXBwbGUgPSB0cnVlO1xuXG4gIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcbiAgX2NyZWF0ZVJpcHBsZShldmVudDogYW55KTogdm9pZCB7XG4gICAgY29uc3QgeyBsYXllclgsIGxheWVyWSB9ID0gZXZlbnQ7XG4gICAgY29uc3Qgb2Zmc2V0WCA9IGxheWVyWDtcbiAgICBjb25zdCBvZmZzZXRZID0gbGF5ZXJZO1xuICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuaG9zdC5vZmZzZXRIZWlnaHQ7XG4gICAgY29uc3Qgd2lkdGggPSB0aGlzLmhvc3Qub2Zmc2V0V2lkdGg7XG4gICAgY29uc3QgZHVyYXRpb24gPSB0aGlzLl9kdXJhdGlvblRvTXNOdW1iZXIodGhpcy5yaXBwbGVEdXJhdGlvbik7XG4gICAgY29uc3QgZGlhbWV0ZXJPcHRpb25zID0ge1xuICAgICAgb2Zmc2V0WDogdGhpcy5yaXBwbGVDZW50ZXJlZCA/IGhlaWdodCAvIDIgOiBvZmZzZXRYLFxuICAgICAgb2Zmc2V0WTogdGhpcy5yaXBwbGVDZW50ZXJlZCA/IHdpZHRoIC8gMiA6IG9mZnNldFksXG4gICAgICBoZWlnaHQsXG4gICAgICB3aWR0aCxcbiAgICB9O1xuICAgIGNvbnN0IGRpYW1ldGVyID0gdGhpcy5fZ2V0RGlhbWV0ZXIoZGlhbWV0ZXJPcHRpb25zKTtcbiAgICBjb25zdCByYWRpdXNWYWx1ZSA9IHRoaXMucmlwcGxlUmFkaXVzIHx8IGRpYW1ldGVyIC8gMjtcblxuICAgIGNvbnN0IG9wYWNpdHkgPSB7XG4gICAgICBkZWxheTogZHVyYXRpb24gKiBUUkFOU0lUSU9OX0JSRUFLX09QQUNJVFksXG4gICAgICBkdXJhdGlvbjogZHVyYXRpb24gLSBkdXJhdGlvbiAqIFRSQU5TSVRJT05fQlJFQUtfT1BBQ0lUWSxcbiAgICB9O1xuXG4gICAgY29uc3Qgc3R5bGVzID0ge1xuICAgICAgbGVmdDogdGhpcy5yaXBwbGVDZW50ZXJlZCA/IGAke3dpZHRoIC8gMiAtIHJhZGl1c1ZhbHVlfXB4YCA6IGAke29mZnNldFggLSByYWRpdXNWYWx1ZX1weGAsXG4gICAgICB0b3A6IHRoaXMucmlwcGxlQ2VudGVyZWQgPyBgJHtoZWlnaHQgLyAyIC0gcmFkaXVzVmFsdWV9cHhgIDogYCR7b2Zmc2V0WSAtIHJhZGl1c1ZhbHVlfXB4YCxcbiAgICAgIGhlaWdodDogYCR7dGhpcy5yaXBwbGVSYWRpdXMgKiAyIHx8IGRpYW1ldGVyfXB4YCxcbiAgICAgIHdpZHRoOiBgJHt0aGlzLnJpcHBsZVJhZGl1cyAqIDIgfHwgZGlhbWV0ZXJ9cHhgLFxuICAgICAgdHJhbnNpdGlvbkRlbGF5OiBgMHMsICR7b3BhY2l0eS5kZWxheX1tc2AsXG4gICAgICB0cmFuc2l0aW9uRHVyYXRpb246IGAke2R1cmF0aW9ufW1zLCAke29wYWNpdHkuZHVyYXRpb259bXNgLFxuICAgIH07XG5cbiAgICBjb25zdCByaXBwbGVIVE1MID0gdGhpcy5fcmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICB0aGlzLl9jcmVhdGVIVE1MUmlwcGxlKHRoaXMuaG9zdCwgcmlwcGxlSFRNTCwgc3R5bGVzKTtcbiAgICB0aGlzLl9yZW1vdmVIVE1MUmlwcGxlKHJpcHBsZUhUTUwsIGR1cmF0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgX2NyZWF0ZUhUTUxSaXBwbGUod3JhcHBlcjogSFRNTEVsZW1lbnQsIHJpcHBsZTogSFRNTEVsZW1lbnQsIHN0eWxlczogYW55KTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMoc3R5bGVzKS5mb3JFYWNoKChwcm9wZXJ0eSkgPT4gKHJpcHBsZS5zdHlsZVtwcm9wZXJ0eV0gPSBzdHlsZXNbcHJvcGVydHldKSk7XG4gICAgdGhpcy5fcmVuZGVyZXIuYWRkQ2xhc3MocmlwcGxlLCAncmlwcGxlLXdhdmUnKTtcblxuICAgIGlmICh0aGlzLnJpcHBsZUNvbG9yICE9PSAnJykge1xuICAgICAgdGhpcy5fcmVtb3ZlT2xkQ29sb3JDbGFzc2VzKHdyYXBwZXIpO1xuICAgICAgdGhpcy5fYWRkQ29sb3IocmlwcGxlLCB3cmFwcGVyKTtcbiAgICB9XG5cbiAgICB0aGlzLl90b2dnbGVVbmJvdW5kKHdyYXBwZXIpO1xuICAgIHRoaXMuX2FwcGVuZFJpcHBsZShyaXBwbGUsIHdyYXBwZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVtb3ZlSFRNTFJpcHBsZShyaXBwbGU6IEhUTUxFbGVtZW50LCBkdXJhdGlvbjogbnVtYmVyKTogdm9pZCB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAocmlwcGxlKSB7XG4gICAgICAgIHJpcHBsZS5yZW1vdmUoKTtcbiAgICAgIH1cbiAgICB9LCBkdXJhdGlvbik7XG4gIH1cblxuICBwcml2YXRlIF9kdXJhdGlvblRvTXNOdW1iZXIodGltZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTnVtYmVyKHRpbWUucmVwbGFjZSgnbXMnLCAnJykucmVwbGFjZSgncycsICcwMDAnKSk7XG4gIH1cblxuICBfZ2V0RGlhbWV0ZXIoeyBvZmZzZXRYLCBvZmZzZXRZLCBoZWlnaHQsIHdpZHRoIH0pOiBudW1iZXIge1xuICAgIGNvbnN0IHRvcCA9IG9mZnNldFkgPD0gaGVpZ2h0IC8gMjtcbiAgICBjb25zdCBsZWZ0ID0gb2Zmc2V0WCA8PSB3aWR0aCAvIDI7XG4gICAgY29uc3QgcHl0aGFnb3JlYW4gPSAoc2lkZUEsIHNpZGVCKSA9PiBNYXRoLnNxcnQoc2lkZUEgKiogMiArIHNpZGVCICoqIDIpO1xuXG4gICAgY29uc3QgcG9zaXRpb25DZW50ZXIgPSBvZmZzZXRZID09PSBoZWlnaHQgLyAyICYmIG9mZnNldFggPT09IHdpZHRoIC8gMjtcbiAgICAvLyBtb3VzZSBwb3NpdGlvbiBvbiB0aGUgcXVhZHJhbnRzIG9mIHRoZSBjb29yZGluYXRlIHN5c3RlbVxuICAgIGNvbnN0IHF1YWRyYW50ID0ge1xuICAgICAgZmlyc3Q6IHRvcCA9PT0gdHJ1ZSAmJiBsZWZ0ID09PSBmYWxzZSxcbiAgICAgIHNlY29uZDogdG9wID09PSB0cnVlICYmIGxlZnQgPT09IHRydWUsXG4gICAgICB0aGlyZDogdG9wID09PSBmYWxzZSAmJiBsZWZ0ID09PSB0cnVlLFxuICAgICAgZm91cnRoOiB0b3AgPT09IGZhbHNlICYmIGxlZnQgPT09IGZhbHNlLFxuICAgIH07XG5cbiAgICBjb25zdCBnZXRDb3JuZXIgPSB7XG4gICAgICB0b3BMZWZ0OiBweXRoYWdvcmVhbihvZmZzZXRYLCBvZmZzZXRZKSxcbiAgICAgIHRvcFJpZ2h0OiBweXRoYWdvcmVhbih3aWR0aCAtIG9mZnNldFgsIG9mZnNldFkpLFxuICAgICAgYm90dG9tTGVmdDogcHl0aGFnb3JlYW4ob2Zmc2V0WCwgaGVpZ2h0IC0gb2Zmc2V0WSksXG4gICAgICBib3R0b21SaWdodDogcHl0aGFnb3JlYW4od2lkdGggLSBvZmZzZXRYLCBoZWlnaHQgLSBvZmZzZXRZKSxcbiAgICB9O1xuXG4gICAgbGV0IGRpYW1ldGVyID0gMDtcblxuICAgIGlmIChwb3NpdGlvbkNlbnRlciB8fCBxdWFkcmFudC5mb3VydGgpIHtcbiAgICAgIGRpYW1ldGVyID0gZ2V0Q29ybmVyLnRvcExlZnQ7XG4gICAgfSBlbHNlIGlmIChxdWFkcmFudC50aGlyZCkge1xuICAgICAgZGlhbWV0ZXIgPSBnZXRDb3JuZXIudG9wUmlnaHQ7XG4gICAgfSBlbHNlIGlmIChxdWFkcmFudC5zZWNvbmQpIHtcbiAgICAgIGRpYW1ldGVyID0gZ2V0Q29ybmVyLmJvdHRvbVJpZ2h0O1xuICAgIH0gZWxzZSBpZiAocXVhZHJhbnQuZmlyc3QpIHtcbiAgICAgIGRpYW1ldGVyID0gZ2V0Q29ybmVyLmJvdHRvbUxlZnQ7XG4gICAgfVxuICAgIHJldHVybiBkaWFtZXRlciAqIDI7XG4gIH1cblxuICBfYXBwZW5kUmlwcGxlKHRhcmdldDogSFRNTEVsZW1lbnQsIHBhcmVudDogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICBjb25zdCBGSVhfQUREX1JJUFBMRV9FRkZFQ1QgPSA1MDsgLy8gZGVsYXkgZm9yIGFjdGl2ZSBhbmltYXRpb25zXG4gICAgdGhpcy5fcmVuZGVyZXIuYXBwZW5kQ2hpbGQocGFyZW50LCB0YXJnZXQpO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuYWRkQ2xhc3ModGFyZ2V0LCAnYWN0aXZlJyk7XG4gICAgfSwgRklYX0FERF9SSVBQTEVfRUZGRUNUKTtcbiAgfVxuXG4gIF90b2dnbGVVbmJvdW5kKHRhcmdldDogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5yaXBwbGVVbmJvdW5kKSB7XG4gICAgICB0aGlzLl9yZW5kZXJlci5hZGRDbGFzcyh0YXJnZXQsICdyaXBwbGUtc3VyZmFjZS11bmJvdW5kJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKHRhcmdldCwgJ3JpcHBsZS1zdXJmYWNlLXVuYm91bmQnKTtcbiAgICB9XG4gIH1cblxuICBfYWRkQ29sb3IodGFyZ2V0OiBIVE1MRWxlbWVudCwgcGFyZW50OiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgIGNvbnN0IGlzQm9vdHN0cmFwQ29sb3IgPSBCT09UU1RSQVBfQ09MT1JTLmZpbmQoXG4gICAgICAoY29sb3IpID0+IGNvbG9yID09PSB0aGlzLnJpcHBsZUNvbG9yLnRvTG93ZXJDYXNlKClcbiAgICApO1xuXG4gICAgaWYgKGlzQm9vdHN0cmFwQ29sb3IpIHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHBhcmVudCwgYCR7J3JpcHBsZS1zdXJmYWNlJ30tJHt0aGlzLnJpcHBsZUNvbG9yLnRvTG93ZXJDYXNlKCl9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJnYlZhbHVlID0gdGhpcy5fY29sb3JUb1JHQih0aGlzLnJpcHBsZUNvbG9yKS5qb2luKCcsJyk7XG4gICAgICBjb25zdCBncmFkaWVudEltYWdlID0gR1JBRElFTlQuc3BsaXQoJ3t7Y29sb3J9fScpLmpvaW4oYCR7cmdiVmFsdWV9YCk7XG4gICAgICB0YXJnZXQuc3R5bGUuYmFja2dyb3VuZEltYWdlID0gYHJhZGlhbC1ncmFkaWVudChjaXJjbGUsICR7Z3JhZGllbnRJbWFnZX0pYDtcbiAgICB9XG4gIH1cblxuICBfcmVtb3ZlT2xkQ29sb3JDbGFzc2VzKHRhcmdldDogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICBjb25zdCBSRUdFWFBfQ0xBU1NfQ09MT1IgPSBuZXcgUmVnRXhwKGAkeydyaXBwbGUtc3VyZmFjZSd9LVthLXpdK2AsICdnaScpO1xuICAgIGNvbnN0IFBBUkVOVF9DTEFTU1NfQ09MT1IgPSB0YXJnZXQuY2xhc3NMaXN0LnZhbHVlLm1hdGNoKFJFR0VYUF9DTEFTU19DT0xPUikgfHwgW107XG4gICAgUEFSRU5UX0NMQVNTU19DT0xPUi5mb3JFYWNoKChjbGFzc05hbWUpID0+IHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKHRhcmdldCwgY2xhc3NOYW1lKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9jb2xvclRvUkdCKGNvbG9yOiBhbnkpOiBudW1iZXJbXSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvdyxAdHlwZXNjcmlwdC1lc2xpbnQvbm8tc2hhZG93XG4gICAgZnVuY3Rpb24gaGV4VG9SZ2IoY29sb3I6IGFueSk6IGFueSB7XG4gICAgICBjb25zdCBIRVhfQ09MT1JfTEVOR1RIID0gNztcbiAgICAgIGNvbnN0IElTX1NIT1JUX0hFWCA9IGNvbG9yLmxlbmd0aCA8IEhFWF9DT0xPUl9MRU5HVEg7XG4gICAgICBpZiAoSVNfU0hPUlRfSEVYKSB7XG4gICAgICAgIGNvbG9yID0gYCMke2NvbG9yWzFdfSR7Y29sb3JbMV19JHtjb2xvclsyXX0ke2NvbG9yWzJdfSR7Y29sb3JbM119JHtjb2xvclszXX1gO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtcbiAgICAgICAgcGFyc2VJbnQoY29sb3Iuc3Vic3RyKDEsIDIpLCAxNiksXG4gICAgICAgIHBhcnNlSW50KGNvbG9yLnN1YnN0cigzLCAyKSwgMTYpLFxuICAgICAgICBwYXJzZUludChjb2xvci5zdWJzdHIoNSwgMiksIDE2KSxcbiAgICAgIF07XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvdyxAdHlwZXNjcmlwdC1lc2xpbnQvbm8tc2hhZG93XG4gICAgZnVuY3Rpb24gbmFtZWRDb2xvcnNUb1JnYmEoY29sb3I6IGFueSk6IGFueSB7XG4gICAgICBjb25zdCB0ZW1wRWxlbSA9IGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZmljdHVtJykpO1xuICAgICAgY29uc3QgZmxhZyA9ICdyZ2IoMSwgMiwgMyknO1xuICAgICAgdGVtcEVsZW0uc3R5bGUuY29sb3IgPSBmbGFnO1xuICAgICAgaWYgKHRlbXBFbGVtLnN0eWxlLmNvbG9yICE9PSBmbGFnKSB7XG4gICAgICAgIHJldHVybiBERUZBVUxUX1JJUFBMRV9DT0xPUjtcbiAgICAgIH1cbiAgICAgIHRlbXBFbGVtLnN0eWxlLmNvbG9yID0gY29sb3I7XG4gICAgICBpZiAodGVtcEVsZW0uc3R5bGUuY29sb3IgPT09IGZsYWcgfHwgdGVtcEVsZW0uc3R5bGUuY29sb3IgPT09ICcnKSB7XG4gICAgICAgIHJldHVybiBERUZBVUxUX1JJUFBMRV9DT0xPUjtcbiAgICAgIH0gLy8gY29sb3IgcGFyc2UgZmFpbGVkXG4gICAgICBjb2xvciA9IGdldENvbXB1dGVkU3R5bGUodGVtcEVsZW0pLmNvbG9yO1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZW1wRWxlbSk7XG4gICAgICByZXR1cm4gY29sb3I7XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvdywgQHR5cGVzY3JpcHQtZXNsaW50L25vLXNoYWRvd1xuICAgIGZ1bmN0aW9uIHJnYmFUb1JnYihjb2xvcjogYW55KTogYW55IHtcbiAgICAgIGNvbG9yID0gY29sb3IubWF0Y2goL1suXFxkXSsvZykubWFwKChhKSA9PiArTnVtYmVyKGEpKTtcbiAgICAgIGNvbG9yLmxlbmd0aCA9IDM7XG4gICAgICByZXR1cm4gY29sb3I7XG4gICAgfVxuXG4gICAgaWYgKGNvbG9yLnRvTG93ZXJDYXNlKCkgPT09ICd0cmFuc3BhcmVudCcpIHtcbiAgICAgIHJldHVybiBERUZBVUxUX1JJUFBMRV9DT0xPUjtcbiAgICB9XG4gICAgaWYgKGNvbG9yWzBdID09PSAnIycpIHtcbiAgICAgIHJldHVybiBoZXhUb1JnYihjb2xvcik7XG4gICAgfVxuICAgIGlmIChjb2xvci5pbmRleE9mKCdyZ2InKSA9PT0gLTEpIHtcbiAgICAgIGNvbG9yID0gbmFtZWRDb2xvcnNUb1JnYmEoY29sb3IpO1xuICAgIH1cbiAgICBpZiAoY29sb3IuaW5kZXhPZigncmdiJykgPT09IDApIHtcbiAgICAgIHJldHVybiByZ2JhVG9SZ2IoY29sb3IpO1xuICAgIH1cblxuICAgIHJldHVybiBERUZBVUxUX1JJUFBMRV9DT0xPUjtcbiAgfVxuXG4gIHN0YXRpYyBuZ0FjY2VwdElucHV0VHlwZV9yaXBwbGVDZW50ZXJlZDogQm9vbGVhbklucHV0O1xuICBzdGF0aWMgbmdBY2NlcHRJbnB1dFR5cGVfcmlwcGxlVW5ib3VuZDogQm9vbGVhbklucHV0O1xufVxuIl19